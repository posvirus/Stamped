import{_ as $,E as N,c as B,e as c,l as i,f as m,g as t,h as x,j as h,m as w,t as u,G as L,a as j,b as I,d as z,w as S,i as P,T as O,k as H,u as R,p as U,s as G,v as q,r as T,B as J,o as K,x as Q}from"./index-BPoUppka.js";import{getTaskById as W}from"./task-lOcNdJg6.js";const X=["disabled","type"],Y={key:0,class:"custom-button__loading"},Z={key:1,class:"custom-button__prefix-icon"},ee={key:2,class:"custom-button__suffix-icon"},te={__name:"CustomButton",props:{type:{type:String,default:"primary",validator:e=>["primary","secondary","danger","ghost","text"].includes(e)},size:{type:String,default:"medium",validator:e=>["small","medium","large"].includes(e)},text:{type:String,default:""},disabled:{type:Boolean,default:!1},loading:{type:Boolean,default:!1},block:{type:Boolean,default:!1},round:{type:Boolean,default:!1},htmlType:{type:String,default:"button",validator:e=>["button","submit","reset"].includes(e)},prefixIcon:{type:String,default:""},suffixIcon:{type:String,default:""},customClass:{type:[String,Array,Object],default:""}},emits:["click","focus","blur","touchstart","touchend"],setup(e,{emit:k}){const o=e,n=k,r=N(),s=B(()=>[`custom-button--${o.type}`,`custom-button--${o.size}`,{"custom-button--disabled":o.disabled,"custom-button--loading":o.loading,"custom-button--block":o.block,"custom-button--round":o.round,"custom-button--icon-only":!o.text&&!r.default&&(o.prefixIcon||o.suffixIcon||r["prefix-icon"]||r["suffix-icon"])},o.customClass]),C=l=>{!o.disabled&&!o.loading&&n("click",l)},f=l=>{n("focus",l)},y=l=>{n("blur",l)},v=l=>{!o.disabled&&!o.loading&&n("touchstart",l)},g=l=>{!o.disabled&&!o.loading&&n("touchend",l)},p=l=>{!o.disabled&&!o.loading&&n("touchend",l)};return(l,b)=>(i(),c("button",{class:h(["custom-button",s.value]),disabled:e.disabled||e.loading,type:e.htmlType,onClick:C,onFocus:f,onBlur:y,onTouchstart:v,onTouchend:g,onTouchcancel:p},[e.loading?(i(),c("div",Y,b[0]||(b[0]=[t("svg",{class:"custom-button__spinner",viewBox:"0 0 24 24"},[t("circle",{class:"custom-button__spinner-path",cx:"12",cy:"12",r:"10"})],-1)]))):m("",!0),e.prefixIcon&&!e.loading?(i(),c("span",Z,[x(l.$slots,"prefix-icon",{},()=>[t("i",{class:h(e.prefixIcon)},null,2)])])):m("",!0),t("span",{class:h(["custom-button__content",{"custom-button__content--hidden":e.loading}])},[x(l.$slots,"default",{},()=>[w(u(e.text),1)])],2),e.suffixIcon&&!e.loading?(i(),c("span",ee,[x(l.$slots,"suffix-icon",{},()=>[t("i",{class:h(e.suffixIcon)},null,2)])])):m("",!0)],42,X))}},D=$(te,[["__scopeId","data-v-5eb8f0f6"]]),oe={key:0,class:"modal__header"},se={class:"modal__title"},ae={key:0},le={key:1,class:"modal__footer"},ne={class:"modal__actions"},ie=Object.assign({inheritAttrs:!1},{__name:"Modal",props:{modelValue:{type:Boolean,default:!1},title:{type:String,default:"提示"},content:{type:String,default:""},size:{type:String,default:"medium",validator:e=>["small","medium","large","fullscreen"].includes(e)},showHeader:{type:Boolean,default:!0},showFooter:{type:Boolean,default:!0},closable:{type:Boolean,default:!0},maskClosable:{type:Boolean,default:!0},escClosable:{type:Boolean,default:!0},showCancelButton:{type:Boolean,default:!0},showConfirmButton:{type:Boolean,default:!0},cancelText:{type:String,default:"取消"},confirmText:{type:String,default:"确认"},confirmType:{type:String,default:"primary",validator:e=>["primary","secondary","danger"].includes(e)},cancelLoading:{type:Boolean,default:!1},confirmLoading:{type:Boolean,default:!1},centered:{type:Boolean,default:!0},customClass:{type:[String,Array,Object],default:""},bodyClass:{type:[String,Array,Object],default:""},zIndex:{type:Number,default:1e3}},emits:["update:modelValue","confirm","cancel","close","open"],setup(e,{emit:k}){R(l=>({"03bea163":e.zIndex}));const o=e,n=k,r=B(()=>[{"modal--centered":o.centered},o.customClass]),s=B(()=>[`modal__container--${o.size}`,{"modal__container--no-header":!o.showHeader,"modal__container--no-footer":!o.showFooter}]),C=B(()=>[{"modal__body--scrollable":o.size!=="fullscreen"},o.bodyClass]),f=()=>{n("update:modelValue",!1),n("close")},y=()=>{n("confirm")},v=()=>{n("cancel"),!o.confirmLoading&&!o.cancelLoading&&f()},g=()=>{o.maskClosable&&!o.confirmLoading&&!o.cancelLoading&&f()},p=l=>{l.key==="Escape"&&o.escClosable&&o.modelValue&&f()};return L(()=>o.modelValue,l=>{l?(document.addEventListener("keydown",p),document.body.style.overflow="hidden",U(()=>{n("open")})):(document.removeEventListener("keydown",p),document.body.style.overflow="")},{immediate:!0}),j(()=>{document.removeEventListener("keydown",p),document.body.style.overflow=""}),(l,b)=>(i(),I(H,{to:"body"},[z(O,{name:"modal",appear:""},{default:S(()=>[e.modelValue?(i(),c("div",{key:0,class:h(["modal",r.value]),onClick:g},[t("div",{class:h(["modal__container",s.value]),onClick:b[0]||(b[0]=P(()=>{},["stop"]))},[e.showHeader?(i(),c("div",oe,[t("div",se,[x(l.$slots,"title",{},()=>[t("h3",null,u(e.title),1)],!0)]),e.closable?(i(),c("button",{key:0,class:"modal__close",onClick:f,"aria-label":"关闭"},b[1]||(b[1]=[t("svg",{viewBox:"0 0 24 24",class:"modal__close-icon"},[t("path",{d:"M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"})],-1)]))):m("",!0)])):m("",!0),t("div",{class:h(["modal__body",C.value])},[x(l.$slots,"default",{},()=>[e.content?(i(),c("p",ae,u(e.content),1)):m("",!0)],!0)],2),e.showFooter?(i(),c("div",le,[x(l.$slots,"footer",{},()=>[t("div",ne,[e.showCancelButton?(i(),I(D,{key:0,type:"secondary",loading:e.cancelLoading,onClick:v},{default:S(()=>[w(u(e.cancelText),1)]),_:1},8,["loading"])):m("",!0),e.showConfirmButton?(i(),I(D,{key:1,type:e.confirmType,loading:e.confirmLoading,onClick:y},{default:S(()=>[w(u(e.confirmText),1)]),_:1},8,["type","loading"])):m("",!0)])],!0)])):m("",!0)],2)],2)):m("",!0)]),_:3})]))}}),de=$(ie,[["__scopeId","data-v-aa291d61"]]),ce={class:"task-detail-page"},ue={key:0,class:"loading-container"},re={key:1,class:"main-content"},me={class:"task-info"},fe={class:"task-title"},ye={key:0,class:"task-description"},ve={class:"task-meta"},ge={class:"meta-item"},be={class:"meta-value"},pe={key:0,class:"meta-item"},he={class:"meta-value"},ke={class:"agreement-section"},Ce={class:"agreement-content"},_e={class:"agreement-text"},xe={class:"actions"},Te=["disabled"],we={key:2,class:"error-container"},Be={style:{margin:"0","line-height":"1.6"}},Se={__name:"TaskDetailPage",setup(e){const k=Q(),o=J(),n=G(),r=q(),s=T(null),C=T(!0),f=T(null),y=T(!1),v=T(!1),g=o.params.id;K(async()=>{await p(),r.setPageTitle("自律工具 - 任务详情")}),L(()=>n.getTaskById(g),d=>{d&&s.value&&(s.value={...d},console.log("任务状态已更新:",d))},{deep:!0});const p=async()=>{try{C.value=!0,f.value=null;const d=n.getTaskById(g);if(d){s.value=d;return}try{const a=await W(g);s.value=a.data||a,s.value&&n.setCurrentTask(s.value)}catch(a){console.warn("API获取任务详情失败，使用本地存储:",a),n.loadFromLocalStorage();const _=n.getTaskById(g);if(_)s.value=_;else throw new Error("任务不存在")}}catch(d){console.error("加载任务详情失败:",d),d.value=d.message||"加载任务详情失败",s.value=null}finally{C.value=!1}},l=()=>{k.back()},b=()=>{k.push(`/task-verify/${g}`)},E=d=>d?new Intl.DateTimeFormat("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}).format(new Date(d)):"",A=()=>{if(console.log("🗑️ 准备删除任务:",s.value),!s.value){r.showError("删除失败：任务数据为空");return}if(!s.value._id){r.showError("删除失败：任务ID为空");return}y.value=!0},F=async()=>{var d;if(console.log("🗑️ 开始删除任务:",s.value),!((d=s.value)!=null&&d._id)){r.showError("删除失败：任务ID为空");return}try{v.value=!0,console.log("🗑️ 调用deleteTask，taskId:",s.value._id),await n.deleteTask(s.value._id)?(r.showSuccess("任务已删除"),console.log("✅ 任务删除成功"),k.push("/")):(r.showError("删除失败，任务不存在"),console.log("❌ 任务删除失败，返回false"))}catch(a){console.error("删除任务失败:",a),r.showError("删除失败: "+a.message)}finally{v.value=!1,y.value=!1}},M=()=>{y.value=!1};return(d,a)=>(i(),c("div",ce,[t("header",{class:"header"},[t("button",{class:"back-button",onClick:l},a[1]||(a[1]=[t("span",{class:"back-icon"},"<",-1)])),a[2]||(a[2]=t("h1",{class:"page-title"},"任务详情",-1)),a[3]||(a[3]=t("div",{class:"header-placeholder"},null,-1))]),C.value?(i(),c("div",ue,a[4]||(a[4]=[t("div",{class:"loading-spinner"},null,-1),t("p",null,"加载中...",-1)]))):s.value?(i(),c("main",re,[t("div",{class:h(["status-badge",s.value.status])},u(s.value.status==="completed"?"已完成":"未完成"),3),t("section",me,[t("h2",fe,u(s.value.title||s.value.description),1),s.value.description&&s.value.title!==s.value.description?(i(),c("p",ye,u(s.value.description),1)):m("",!0),t("div",ve,[t("div",ge,[a[5]||(a[5]=t("span",{class:"meta-label"},"创建时间：",-1)),t("span",be,u(E(s.value.createdAt)),1)]),s.value.completedAt?(i(),c("div",pe,[a[6]||(a[6]=t("span",{class:"meta-label"},"完成时间：",-1)),t("span",he,u(E(s.value.completedAt)),1)])):m("",!0)])]),t("section",ke,[a[7]||(a[7]=t("h3",{class:"section-title"},"验证协议",-1)),t("div",Ce,[t("pre",_e,u(s.value.agreement),1)])]),t("div",xe,[s.value.status==="pending"?(i(),c("button",{key:0,class:"verify-button",onClick:b}," 验证 ")):m("",!0),t("button",{class:"delete-button",onClick:A,disabled:v.value},u(v.value?"删除中...":"删除"),9,Te)])])):(i(),c("div",we,[t("p",null,u(f.value||"任务不存在或加载失败"),1),t("button",{class:"retry-button",onClick:p},"重试")])),z(de,{modelValue:y.value,"onUpdate:modelValue":a[0]||(a[0]=_=>y.value=_),title:"确认删除","confirm-type":"danger","confirm-text":"删除","cancel-text":"取消","mask-closable":!0,"confirm-loading":v.value,onConfirm:F,onCancel:M},{default:S(()=>{var _,V;return[t("p",Be,[a[8]||(a[8]=w(' 确定要删除任务"')),t("strong",null,u(((_=s.value)==null?void 0:_.title)||((V=s.value)==null?void 0:V.description)),1),a[9]||(a[9]=w('"吗？ '))]),a[10]||(a[10]=t("p",{style:{margin:"8px 0 0 0","font-size":"14px",color:"#666"}}," 此操作不可撤销，任务数据将被永久删除。 ",-1))]}),_:1,__:[10]},8,["modelValue","confirm-loading"])]))}},Ee=$(Se,[["__scopeId","data-v-6d1d62af"]]);export{Ee as default};
