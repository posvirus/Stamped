import{_ as D,s as U,v as V,r as u,B as $,o as z,x as M,e as r,g as s,f as _,z as b,j as P,H as L,t as f,A as R,F,y as N,I as G,l as i}from"./index-BPoUppka.js";import{updateTaskStatus as j}from"./task-lOcNdJg6.js";const H={class:"task-verify-page"},J={key:0,class:"loading-container"},W={key:1,class:"main-content"},q={class:"task-info-panel"},K={class:"panel-content"},O={class:"task-summary"},Q={class:"agreement-summary"},X={class:"agreement-text"},Y={class:"verification-section"},Z={class:"input-group"},ee={class:"char-count"},se={class:"image-upload-section"},te={class:"image-grid"},ae=["src","alt"],oe=["onClick"],le={key:0,class:"upload-button"},ne={class:"submit-section"},re=["disabled"],ie={key:0,class:"loading-text"},ce={key:1},ue={__name:"TaskVerifyPage",setup(de){const d=M(),T=$(),n=U(),k=V(),c=u(null),h=u(!0),p=u(!1),v=u(""),o=u([]),m=u(!1),g=T.params.id;z(async()=>{await w()});const w=async()=>{try{n.setLoading(!0);const a=n.getTaskById(g);if(!a)throw new Error("任务不存在");c.value=a}catch(a){console.error("加载任务详情失败:",a),n.setError("加载任务详情失败"),alert("加载任务详情失败，请返回重试"),d.back()}finally{h.value=!1,n.setLoading(!1)}},x=()=>{d.back()},I=a=>{const e=Array.from(a.target.files);if(o.value.length+e.length>3){alert("最多只能上传3张图片");return}e.forEach(t=>{if(t.type.startsWith("image/")){if(t.size>5*1024*1024){alert(`图片 ${t.name} 超过5MB大小限制`);return}const l=new FileReader;l.onload=E=>{const y=E.target.result,A=y.split(",")[1];o.value.push({id:Date.now()+Math.random(),file:t,url:y,base64:A,name:t.name,size:t.size,type:t.type})},l.readAsDataURL(t)}}),a.target.value=""},S=a=>{o.value=o.value.filter(e=>e.id!==a)},B=(a,e)=>`data:${e};base64,${a}`,C=async()=>{if(o.value.length===0){alert("请至少上传一张图片");return}m.value=!0,n.clearError();try{const a=o.value.map(l=>B(l.base64,l.type)),e={goal:c.value.title,agreement:c.value.agreement,description:v.value.trim(),imageUrls:a},t=await G(e);if(t.success)try{if(await j(g,"completed"),console.log("✅ 服务器端任务状态更新成功"),n.completeTask(g))k.showSuccess("任务完成！恭喜您达成目标！",4e3),setTimeout(()=>{d.push("/")},1500);else throw new Error("更新本地任务状态失败")}catch(l){console.error("❌ 更新任务状态失败:",l),n.completeTask(g),k.showSuccess("任务验证成功！但状态同步可能有延迟",4e3),setTimeout(()=>{d.push("/")},1500)}else alert(`验证未通过：${t.reason}`)}catch(a){console.error("验证失败:",a),n.setError(a.message),a.message.includes("API密钥")?alert("AI服务配置错误，请联系管理员"):alert("验证失败，请检查网络连接后重试")}finally{m.value=!1}};return(a,e)=>(i(),r("div",H,[s("header",{class:"header"},[s("button",{class:"back-button",onClick:x},e[2]||(e[2]=[s("span",{class:"back-icon"},"<",-1)])),e[3]||(e[3]=s("h1",{class:"page-title"},"任务验证",-1)),e[4]||(e[4]=s("div",{class:"header-placeholder"},null,-1))]),h.value?(i(),r("div",J,e[5]||(e[5]=[s("div",{class:"loading-spinner"},null,-1),s("p",null,"加载中...",-1)]))):c.value?(i(),r("main",W,[s("div",q,[s("button",{class:"panel-toggle",onClick:e[0]||(e[0]=t=>p.value=!p.value)},[e[6]||(e[6]=s("span",{class:"panel-title"},"查看目标与任务",-1)),s("span",{class:P(["toggle-icon",{open:p.value}])},"▼",2)]),b(s("div",K,[s("div",O,[s("h3",null,f(c.value.title),1)]),s("div",Q,[s("pre",X,f(c.value.agreement),1)])],512),[[L,p.value]])]),s("div",Y,[e[11]||(e[11]=s("h3",{class:"section-title"},"验证材料",-1)),s("div",Z,[e[7]||(e[7]=s("label",{for:"verification-text",class:"input-label"},"完成情况描述（可选）",-1)),b(s("textarea",{id:"verification-text","onUpdate:modelValue":e[1]||(e[1]=t=>v.value=t),class:"verification-input",placeholder:"请描述你的完成情况……",rows:"1",maxlength:"100"},null,512),[[R,v.value]]),s("div",ee,f(v.value.length)+"/100 ",1)]),s("div",se,[e[9]||(e[9]=s("label",{class:"input-label"},"上传照片（最多3张）",-1)),s("div",te,[(i(!0),r(F,null,N(o.value,t=>(i(),r("div",{key:t.id,class:"image-item"},[s("img",{src:t.url,alt:t.name,class:"uploaded-image"},null,8,ae),s("button",{class:"remove-button",onClick:l=>S(t.id)}," × ",8,oe)]))),128)),o.value.length<3?(i(),r("label",le,[s("input",{type:"file",accept:"image/*",multiple:"",class:"file-input",onChange:I},null,32),e[8]||(e[8]=s("div",{class:"upload-content"},[s("span",{class:"upload-icon"},"+")],-1))])):_("",!0)]),e[10]||(e[10]=s("p",{class:"upload-hint"}," 支持JPG、PNG格式，单张图片不超过5MB ",-1))])]),s("div",ne,[s("button",{class:"submit-button",disabled:o.value.length===0||m.value,onClick:C},[m.value?(i(),r("span",ie," AI验证中... ")):(i(),r("span",ce," 提交验证 "))],8,re)])])):_("",!0)]))}},me=D(ue,[["__scopeId","data-v-c6ec15a3"]]);export{me as default};
